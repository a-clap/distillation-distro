From 3c784a593f0b272b6d8fdce68aa2965c79f2da5d Mon Sep 17 00:00:00 2001
From: a-clap <clapinskiadam@gmail.com>
Date: Thu, 29 Sep 2022 22:54:10 +0200
Subject: [PATCH] BBB GPU support

---
 eurasia_km/services4/srvkm/env/linux/module.c        |  3 ++-
 .../services4/srvkm/env/linux/pvr_linux_fence.c      | 12 ++++++------
 2 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/eurasia_km/services4/srvkm/env/linux/module.c b/eurasia_km/services4/srvkm/env/linux/module.c
index d4ea107..340ea27 100644
--- a/eurasia_km/services4/srvkm/env/linux/module.c
+++ b/eurasia_km/services4/srvkm/env/linux/module.c
@@ -159,6 +159,7 @@ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #if defined(PVR_LDM_MODULE)
 #define	DRVNAME		PVR_LDM_DRIVER_REGISTRATION_NAME
 #endif
+#define DRVNAME		PVRSRV_MODNAME
 #define DEVNAME		PVRSRV_MODNAME
 
 #if defined(SUPPORT_DRI_DRM)
@@ -170,7 +171,7 @@ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 /*
  * This is all module configuration stuff required by the linux kernel.
  */
-MODULE_SUPPORTED_DEVICE(DEVNAME);
+//MODULE_SUPPORTED_DEVICE(DEVNAME);
 
 #if defined(PVRSRV_NEED_PVR_DPF)
 #include <linux/moduleparam.h>
diff --git a/eurasia_km/services4/srvkm/env/linux/pvr_linux_fence.c b/eurasia_km/services4/srvkm/env/linux/pvr_linux_fence.c
index c3c2fdf..70e40b2 100644
--- a/eurasia_km/services4/srvkm/env/linux/pvr_linux_fence.c
+++ b/eurasia_km/services4/srvkm/env/linux/pvr_linux_fence.c
@@ -424,7 +424,7 @@ static int update_dma_resv_fences_dst(struct pvr_fence_frame *pvr_fence_frame,
 	unsigned i;
 	int ret;
 
-	flist = dma_resv_get_list(resv);
+	flist = dma_resv_shared_list(resv);
 	shared_fence_count = flist ? flist->shared_count : 0;
 
 	fence_to_signal = create_fence_to_signal(pvr_fence_frame);
@@ -442,9 +442,9 @@ static int update_dma_resv_fences_dst(struct pvr_fence_frame *pvr_fence_frame,
 	if (!shared_fence_count)
 	{
 #if (LINUX_VERSION_CODE >= KERNEL_VERSION(4,10,0))
-		struct dma_fence *fence = dma_resv_get_excl(resv);
+		struct dma_fence *fence = dma_resv_excl_fence(resv);
 #else
-		struct fence *fence = dma_resv_get_excl(resv);
+		struct fence *fence = dma_resv_excl_fence(resv);
 #endif
 
 		if (fence && is_blocking_fence(fence, pvr_fence_frame))
@@ -559,7 +559,7 @@ static int update_dma_resv_fences_src(struct pvr_fence_frame *pvr_fence_frame,
 		return 0;
 	}
 
-	flist = dma_resv_get_list(resv);
+	flist = dma_resv_shared_list(resv);
 	shared_fence_count = flist ? flist->shared_count : 0;
 
 	/*
@@ -606,9 +606,9 @@ static int update_dma_resv_fences_src(struct pvr_fence_frame *pvr_fence_frame,
 	if (!blocking_fence && !shared_fence_count)
 	{
 #if (LINUX_VERSION_CODE >= KERNEL_VERSION(4,10,0))
-		struct dma_fence *fence = dma_resv_get_excl(resv);
+		struct dma_fence *fence = dma_resv_excl_fence(resv);
 #else
-		struct fence *fence = dma_resv_get_excl(resv);
+		struct fence *fence = dma_resv_excl_fence(resv);
 #endif
 
 		if (fence && is_blocking_fence(fence, pvr_fence_frame))
